<% active_mode = song.mode.presence || 'simple' %>
<% active_lyrics_mode = song.lyrics_mode.presence || 'auto' %>


<%= form_with model: song, id: "song_form", class: "bg-main flex flex-col i-full b-full", data: { controller: "song-panel dirty-form" } do |form| %>

  <%# Dynamically set the hidden mode field based on the last used mode. %>
  <%= form.hidden_field :mode, value: active_mode, data: { song_panel_target: "modeInput" } %>

  <%# The main content area that grows and becomes scrollable. %>
  <div class="grow overflow-y-auto p-5">

    <% if @song.errors.any? %>
      <div class="alert alert--negative flex items-start mbe-5" role="alert">
        <span class="icon icon--circle-alert" aria-hidden="true"></span>
        <div class="flex flex-col mis-3">
          <h5 class="font-medium leading-none mbe-1">Unable to create song.</h5>
          <div class="flex flex-col text-sm">
            <p class="mbe-2"><%= pluralize(@song.errors.count, "error") %> prohibited this song from being saved:</p>
            <ul class="mis-3" style="list-style: disc">
              <% @song.errors.each do |error| %>
                <li><%= error.full_message %></li>
              <% end %>
            </ul>
          </div>
        </div>
      </div>
    <% end %>

    <div class="flex flex-col gap-2 mbe-6">
      <%= form.label :title, "Title (optional)", class: "text-sm font-medium" %>
      <%= form.text_field :title, placeholder: "My Awesome Song", class: "input bg-shade border-subtle" %>
    </div>

    <%# Use the 'active_mode' variable to tell the tabs controller which tab to show on load. %>
    <div class="tabs i-full" data-controller="tabs" data-tabs-initial-index-value="<%= active_mode == 'custom' ? 1 : 0 %>">
      <div class="tabs__list" role="tablist">
        <button type="button" id="trigger_simple" class="btn tabs__button" data-tabs-target="button" data-action="tabs#select song-panel#setMode" data-mode="simple" role="tab" aria-controls="tab_simple">Simple</button>
        <button type="button" id="trigger_custom" class="btn tabs__button" data-tabs-target="button" data-action="tabs#select song-panel#setMode" data-mode="custom" role="tab" aria-controls="tab_custom">Custom</button>
      </div>

      <%# === SIMPLE MODE TAB === %>
      <div hidden id="tab_simple" data-tabs-target="tab" role="tabpanel" aria-labelledby="trigger_simple" class="mbs-6">
        <div class="flex flex-col gap-6">
          <div class="flex flex-col gap-2">
            <%= form.label :full_described_song, "Describe your song", class: "text-sm font-medium" %>
            <%= form.text_area :full_described_song,
                  placeholder: "A dreamy lofi hip hop song...",
                  class: "input bg-shade border-subtle",
                  style: "min-block-size: 120px; resize: none;",
                  data: { song_panel_target: "descriptionField" } %>
          </div>
          <div class="flex items-center justify-between">
            <button type="button"
                    class="btn btn--secondary"
                    data-action="click->tabs#selectByIndex"
                    data-tabs-index-param="1">
              <span class="icon icon--plus mie-2" aria-hidden="true"></span>
              Lyrics
            </button>
            <div class="flex items-center gap-2">
              <%= form.label :instrumental_simple, "Instrumentals", class: "text-sm font-medium" %>
              <%= form.check_box :instrumental, { id: "instrumental_simple", class: "cursor-pointer switch", role: "switch" } %>
            </div>
          </div>
          <div class="flex flex-col gap-2">
            <label class="text-sm font-medium">Inspiration</label>
            <div class="flex flex-wrap gap-2 pbe-2">
              <% @inspiration_tags.each do |tag| %>
                <button type="button" class="btn btn--secondary text-xs" data-tag="<%= tag %>" data-action="song-panel#addInspirationTag">
                  <span class="icon icon--plus mie-1" aria-hidden="true"></span> <%= tag %>
                </button>
              <% end %>
            </div>
          </div>
        </div>
      </div>

      <%# === CUSTOM MODE TAB === %>
      <div hidden id="tab_custom" data-tabs-target="tab" role="tabpanel" aria-labelledby="trigger_custom" class="mbs-6">
        <%# Dynamically set the hidden field for the last used lyrics mode. %>
        <%= form.hidden_field :lyrics_mode, value: active_lyrics_mode, data: { song_panel_target: "lyricsModeInput" } %>
        <div class="flex flex-col gap-6">
          <div class="flex flex-col gap-2">
            <div class="flex items-center justify-between">
              <label class="text-sm font-medium">Lyrics</label>
              <div class="flex items-center gap-1">
                <%# Dynamically set the active button style based on the 'active_lyrics_mode' variable. %>
                <button type="button" class="btn text-xs <%= active_lyrics_mode == 'auto' ? 'btn--secondary' : 'btn--borderless' %>" data-lyrics-mode="auto" data-song-panel-target="autoLyricsButton" data-action="song-panel#selectLyricsMode">Auto</button>
                <button type="button" class="btn text-xs <%= active_lyrics_mode == 'write' ? 'btn--secondary' : 'btn--borderless' %>" data-lyrics-mode="write" data-song-panel-target="writeLyricsButton" data-action="song-panel#selectLyricsMode">Write</button>
              </div>
            </div>
            <%# Dynamically set the placeholder text to match the active lyrics mode. %>
            <%= form.text_area :lyrics,
                  placeholder: (active_lyrics_mode == 'auto' ? 'Describe your lyrics...' : 'Add your own lyrics here'),
                  class: "input bg-shade border-subtle",
                  style: "min-block-size: 120px; resize: none;",
                  data: { song_panel_target: "lyricsField" } %>
          </div>
          <div class="flex items-center justify-between">
            <label for="instrumental_custom" class="text-sm font-medium">Instrumentals</label>
            <%= form.check_box :instrumental, { id: "instrumental_custom", class: "switch cursor-pointer", role: "switch" } %>
          </div>
          <div class="flex flex-col gap-2">
            <%= form.label :prompt, "Styles", class: "text-sm font-medium" %>
            <%= form.text_area :prompt,
                  placeholder: "Select style tags below or add your own...",
                  class: "input bg-shade border-subtle",
                  style: "min-block-size: 60px; resize: none;",
                  data: { song_panel_target: "styleField" } %>
            <div class="overflow-x-auto rounded-md border" style="block-size: 10dvh; min-block-size: 8rem;">
              <div class="p-4">
                <div class="flex flex-wrap gap-2 pbe-2">
                  <% @categories.each do |category| %>
                    <button type="button" class="badge badge--secondary cursor-pointer" data-tag="<%= category.name %>" data-action="song-panel#addStyleTag">
                      <%= category.name %>
                    </button>
                  <% end %>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <%# The sticky footer with the `mbs-auto` class to push it to the bottom. %>
  <div class="mbs-auto border-bs border-subtle p-5">
    <%= form.button class: "btn i-full text-gray-50 bg-rose-500 hover:bg-rose-600", data: { song_panel_target: "submitButton" } do %>
      <span class="icon icon--loading animate-spin hidden" data-song-panel-target="spinnerIcon" aria-hidden="true"></span>
      <span class="icon icon--music" data-song-panel-target="musicIcon" aria-hidden="true"></span>
      <span class="mis-2" data-song-panel-target="submitButtonText">Create</span>
    <% end %>
  </div>
<% end %>