<%= tag.div(
  class: "track-item #{'is-generating' if song.pending? || song.processing?} #{'is-failed' if song.failed?} #{'has-error' if song.no_credits?}",
  id: dom_id(song)
) do %>
  <% case song.status %>
  <% when "failed" %>
    <div class="flex items-center gap p-3 rounded-lg" style="cursor: not-allowed;">
      <div class="flex items-center justify-center shrink-0 rounded-md" style="block-size: 3rem; inline-size: 3rem;">
        <span class="icon icon--circle-alert text-negative p-4" style="font-size: 1.5rem;"></span>
      </div>
      <div class="min-i-0 grow">
        <h3 class="text-negative overflow-ellipsis">Generation Failed</h3>
        <p class="text-subtle overflow-ellipsis text-sm">There was a technical issue. Please try again.</p>
      </div>
    </div>

  <% when "no_credits" %>
    <div class="flex items-center gap p-3 rounded-lg" style="cursor: not-allowed;">
      <div class="flex items-center justify-center shrink-0 rounded-md" style="block-size: 3rem; inline-size: 3rem;">
        <span class="icon icon--circle-alert text-negative p-4" style="font-size: 1.5rem;"></span>
      </div>
      <div class="min-i-0 grow">
        <h3 class="text-negative overflow-ellipsis">Not Enough Credits</h3>
        <p class="text-subtle overflow-ellipsis text-sm">Please purchase more credits to generate more songs.</p>
      </div>
    </div>

  <% when "pending", "processing" %>
    <div class="flex items-center gap p-3 rounded-lg" style="cursor: not-allowed;">
      <div class="bg-shade flex items-center justify-center shrink-0 rounded-md" style="block-size: 3rem; inline-size: 3rem;">
        <span class="icon icon--loading animate-spin text-subtle p-4" style="font-size: 1.5rem;"></span>
      </div>
      <div class="min-i-0 grow" style="max-inline-size: 35ch;">
        <h3 class="text-subtle overflow-ellipsis"><%= song.title %> (<%= song.status.humanize %>...)</h3>
        <p class="text-subtle overflow-ellipsis text-sm">This will update automatically when complete.</p>
      </div>
    </div>

  <% when "processed" %>
    <div class="flex items-center justify-between py-3 px-0 rounded-lg">
      <div class="flex items-center gap-3">
        <%# This button now calls the global `player` controller directly. %>
        <button type="button" style="width: auto;" class="card-image-wrapper shrink-0"
                data-action="player#show"
                data-player-url-param="<%= presigned_s3_url(song.s3_key) %>"
                data-player-title-param="<%= song.title %>"
                data-player-artist-param="<%= song.user.name %>"
                data-player-artwork-param="<%= presigned_s3_url(song.thumbnail_s3_key) %>">
          <div class="relative rounded-md overflow-hidden" style="block-size: 3rem; inline-size: 3rem;">
            <% if thumbnail_url = presigned_s3_url(song.thumbnail_s3_key) %>
              <%= image_tag thumbnail_url, class: "b-full i-full object-cover", alt: song.title %>
            <% else %>
              <div class="bg-surface b-full i-full flex items-center justify-center">
                <span class="icon icon--music text-subtle" style="--icon-size: 1.5rem;"></span>
              </div>
            <% end %>
            <div class="card-overlay flex items-center justify-center">
              <span class="icon icon--play text-gray-50" style="--icon-size: 1.5rem"></span>
            </div>
          </div>
        </button>
        
        <div class="min-i-0 grow" style="max-inline-size: 35ch;">
          <h3><%= song.title %></h3>
          <p class="text-subtle overflow-ellipsis text-sm"><%= song.prompt %></p>
        </div>
      </div>
      
      <div class="flex items-center gap-3">
        <%= render "songs/publish_button", song: song %>
        <%= render "songs/edit_and_download_button", song: song %>
      </div>
    </div>
  <% end %>
<% end %>