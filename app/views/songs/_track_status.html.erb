<%= tag.div(
  class: "track-item #{'is-generating' if song.pending? || song.processing?} #{'is-failed' if song.failed?} #{'has-error' if song.no_credits?}",
  id: dom_id(song)
) do %>
  <% case song.status %>
  <% when "failed", "no_credits" %>
    <div class="flex items-center justify-between py-3 px-0 rounded-lg">
      <div class="flex items-center gap-3">
        <div class="flex items-center justify-center shrink-0 rounded-md" style="block-size: 3rem; inline-size: 3rem;">
          <span class="icon icon--circle-alert text-negative p-4" style="font-size: 1.5rem;"></span>
        </div>
        <div class="min-i-0 grow" style="max-inline-size: 30dvw;">
          <h3 class="text-negative">Generation Failed</h3>
          <h3><%= song.title %></h3>
          <% if song.failed? %>
            <p class="text-subtle text-sm mbs-2">There was a technical issue. Please try again or <%= link_to "contact support", "#", class: "text-rose-500" %>.</p>
          <% else %>
            <p class="text-negative overflow-ellipsis text-sm">Not enough credits</p>
          <% end %>
        </div>
      </div>
      
      <div class="flex items-center gap-3">
        <%= button_to "Retry", "#", method: :post, class: "btn btn--secondary text-xs", title: "Retry generation" %>
        <%= button_to "Delete", song_path(song), method: :delete, class: "btn btn--negative text-xs", title: "Delete song", form: { data: { turbo_confirm: "Are you sure?" } } %>
      </div>
    </div>

  <% when "pending", "processing" %>
    <div class="flex items-center gap py-3 px-0 rounded-lg justify-between" style="cursor: not-allowed;">
      <div class="flex items-center gap-3">
        <div class="bg-shade flex items-center justify-center shrink-0 rounded-md" style="block-size: 3rem; inline-size: 3rem;">
          <span class="icon icon--loading animate-spin text-subtle p-4" style="font-size: 1.5rem;"></span>
        </div>
        <div class="min-i-0 grow" style="max-inline-size: 30dvw;">
          <h3 class="text-subtle overflow-ellipsis"><%= song.title %> (<%= song.status.humanize %>...)</h3>
          <p class="text-subtle overflow-ellipsis text-sm">This will update automatically when complete.</p>
        </div>
      </div>

      <div>
        <%= button_to "Delete", song_path(song), method: :delete, class: "btn btn--negative text-xs", title: "Delete song", form: { data: { turbo_confirm: "Are you sure?" } } %>
      </div>
    </div>

  <% when "processed" %>
    <div class="flex items-center justify-between py-3 px-0 rounded-lg">
      <div class="flex items-center gap-3">
        <%# This button now calls the global `player` controller directly. %>
        <button type="button" style="width: auto;" class="card-image-wrapper shrink-0"
                data-action="player#show"
                data-player-url-param="<%= presigned_s3_url(song.s3_key) %>"
                data-player-title-param="<%= song.title %>"
                data-player-artist-param="<%= song.user.name %>"
                data-player-artwork-param="<%= presigned_s3_url(song.thumbnail_s3_key) %>">
          <div class="relative rounded-md overflow-hidden" style="block-size: 3rem; inline-size: 3rem;">
            <% if thumbnail_url = presigned_s3_url(song.thumbnail_s3_key) %>
              <%= image_tag thumbnail_url, class: "b-full i-full object-cover", alt: song.title %>
            <% else %>
              <div class="bg-surface b-full i-full flex items-center justify-center">
                <span class="icon icon--music text-subtle" style="--icon-size: 1.5rem;"></span>
              </div>
            <% end %>
            <div class="card-overlay flex items-center justify-center">
              <span class="icon icon--play text-gray-50" style="--icon-size: 1.5rem"></span>
            </div>
          </div>
        </button>
        
        <div class="min-i-0 grow" style="max-inline-size: 30dvw;">
          <h3><%= song.title %></h3>
          <p class="text-subtle overflow-ellipsis text-sm"><%= song.prompt %></p>
        </div>
      </div>
      
      <div class="flex items-center gap-3">
        <%= render "songs/publish_button", song: song %>
        <%= render "songs/edit_and_download_button", song: song %>
      </div>
    </div>
  <% end %>
<% end %>